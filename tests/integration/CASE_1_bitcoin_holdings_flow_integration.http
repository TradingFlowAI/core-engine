### Bitcoin Holdings Flow Integration Test
### 比特币持仓数据爬取流程集成测试
@baseUrl = http://localhost:7002
@flowId = 6885d7bd10696775b384158c
@cycle = 1
@codeNodeId = code_node_1
@datasetNodeId = dataset_output_node_1

# =============================================================================
# Part 1: 单个节点测试 (Individual Node Tests)
# =============================================================================

### 1.1 测试 Code Node - 比特币持仓数据爬取
# @name execute_code_node
POST {{baseUrl}}/nodes/execute
Content-Type: application/json
Accept: application/json

{
  "flow_id": "{{flowId}}",
  "component_id": 0,
  "cycle": {{cycle}},
  "node_id": "{{codeNodeId}}",
  "node_type": "code_node",
  "name": "Bitcoin Holdings Scraper",
  "edges": [
    {
      "source": "{{codeNodeId}}",
      "source_handle": "output_data",
      "target": "{{datasetNodeId}}",
      "target_handle": "data"
    }
  ],
  "config": {
    "node_class_type": "code_node",
    "python_code": "# 使用 requests 和 BeautifulSoup 爬取比特币持仓数据\nimport requests\nfrom bs4 import BeautifulSoup\nimport pandas as pd\nurl = 'https://bitcointreasuries.net/'\nresp = requests.get(url)\nsoup = BeautifulSoup(resp.text, 'html.parser')\ntable = soup.find('table')\nrows = table.find_all('tr')\ndata = []\nfor row in rows[1:]:\n    cols = [col.get_text(strip=True) for col in row.find_all('td')]\n    if cols:\n        data.append(cols)\ndf = pd.DataFrame(data)\noutput_data = df.to_dict(orient='records')\n",
    "input_data": {}
  }
}

### 1.2 查询 Code Node 执行状态
# @name get_code_node_status
GET {{baseUrl}}/nodes/{{flowId}}_{{cycle}}_{{codeNodeId}}/status
Content-Type: application/json

### 1.3 测试 Dataset Output Node - 数据输出
# @name execute_dataset_output_node
POST {{baseUrl}}/nodes/execute
Content-Type: application/json
Accept: application/json

{
  "flow_id": "{{flowId}}",
  "component_id": 1,
  "cycle": {{cycle}},
  "node_id": "{{datasetNodeId}}",
  "node_type": "dataset_output_node",
  "name": "Dataset Output Node",
  "edges": [],
  "config": {
    "node_class_type": "dataset_output_node",
    "data": {
      "sample": "data from code_node will be injected here"
    },
    "doc_link": "https://bitcointreasuries.net/"
  }
}

### 1.4 查询 Dataset Output Node 执行状态
# @name get_dataset_node_status
GET {{baseUrl}}/nodes/{{flowId}}_{{cycle}}_{{datasetNodeId}}/status
Content-Type: application/json

# =============================================================================
# Part 2: 完整流程测试 (Complete Flow Tests)
# =============================================================================

### 2.1 执行完整的比特币持仓数据爬取流程
# @name execute_bitcoin_holdings_flow
POST {{baseUrl}}/flows/execute
Content-Type: application/json

{
    "flow_id": "{{flowId}}",
    "cycle_interval": "0",
    "flow_json": {
        "nodes": [
            {
                "id": "{{codeNodeId}}",
                "type": "code_node",
                "config": {
                    "node_class_type": "code_node",
                    "python_code": "# 使用 requests 和 BeautifulSoup 爬取比特币持仓数据\nimport requests\nfrom bs4 import BeautifulSoup\nimport pandas as pd\nurl = 'https://bitcointreasuries.net/'\nresp = requests.get(url)\nsoup = BeautifulSoup(resp.text, 'html.parser')\ntable = soup.find('table')\nrows = table.find_all('tr')\ndata = []\nfor row in rows[1:]:\n    cols = [col.get_text(strip=True) for col in row.find_all('td')]\n    if cols:\n        data.append(cols)\ndf = pd.DataFrame(data)\noutput_data = df.to_dict(orient='records')\n",
                    "input_data": {}
                }
            },
            {
                "id": "{{datasetNodeId}}",
                "type": "dataset_output_node",
                "config": {
                    "node_class_type": "dataset_output_node",
                    "data": {},
                    "doc_link": "https://bitcointreasuries.net/"
                }
            }
        ],
        "edges": [
            {
                "source": "{{codeNodeId}}",
                "source_handle": "output_data",
                "target": "{{datasetNodeId}}",
                "target_handle": "data"
            }
        ]
    }
}

### 2.2 获取流程执行状态
# @name get_flow_status
GET {{baseUrl}}/flows/{{flowId}}/status
Content-Type: application/json

### 2.3 获取流程执行日志
# @name get_flow_logs
GET {{baseUrl}}/flows/{{flowId}}/logs
Content-Type: application/json

### 2.4 获取流程执行日志（带过滤条件）
# @name get_flow_logs_filtered
GET {{baseUrl}}/flows/{{flowId}}/logs?cycle={{cycle}}&node_id={{codeNodeId}}&log_level=INFO&limit=20&offset=0&order_by=created_at&order_direction=desc
Content-Type: application/json

### 2.5 获取特定节点的执行日志
# @name get_code_node_logs
GET {{baseUrl}}/flows/{{flowId}}/cycles/{{cycle}}/nodes/{{codeNodeId}}/logs
Content-Type: application/json

### 2.6 获取数据输出节点的执行日志
# @name get_dataset_node_logs
GET {{baseUrl}}/flows/{{flowId}}/cycles/{{cycle}}/nodes/{{datasetNodeId}}/logs
Content-Type: application/json

### 2.7 停止流程执行
# @name stop_flow
POST {{baseUrl}}/flows/{{flowId}}/stop
Content-Type: application/json

# =============================================================================
# Part 3: 高级测试场景 (Advanced Test Scenarios)
# =============================================================================

### 3.1 测试定时执行流程（每分钟执行一次）
# @name execute_scheduled_flow
POST {{baseUrl}}/flows/execute
Content-Type: application/json

{
    "flow_id": "{{flowId}}_scheduled",
    "cycle_interval": "60",
    "flow_json": {
        "nodes": [
            {
                "id": "{{codeNodeId}}_scheduled",
                "type": "code_node",
                "config": {
                    "node_class_type": "code_node",
                    "python_code": "# 定时爬取比特币持仓数据\nimport requests\nfrom bs4 import BeautifulSoup\nimport pandas as pd\nfrom datetime import datetime\nprint(f'Starting Bitcoin holdings scraping at {datetime.now()}')\nurl = 'https://bitcointreasuries.net/'\nresp = requests.get(url)\nsoup = BeautifulSoup(resp.text, 'html.parser')\ntable = soup.find('table')\nrows = table.find_all('tr')\ndata = []\nfor row in rows[1:]:\n    cols = [col.get_text(strip=True) for col in row.find_all('td')]\n    if cols:\n        data.append(cols)\ndf = pd.DataFrame(data)\nprint(f'Scraped {len(df)} records')\noutput_data = {'timestamp': datetime.now().isoformat(), 'data': df.to_dict(orient='records'), 'count': len(df)}\n",
                    "input_data": {}
                }
            },
            {
                "id": "{{datasetNodeId}}_scheduled",
                "type": "dataset_output_node",
                "config": {
                    "node_class_type": "dataset_output_node",
                    "data": {},
                    "doc_link": "https://bitcointreasuries.net/"
                }
            }
        ],
        "edges": [
            {
                "source": "{{codeNodeId}}_scheduled",
                "source_handle": "output_data",
                "target": "{{datasetNodeId}}_scheduled",
                "target_handle": "data"
            }
        ]
    }
}

### 3.2 获取定时流程状态
# @name get_scheduled_flow_status
GET {{baseUrl}}/flows/{{flowId}}_scheduled/status
Content-Type: application/json

### 3.3 停止定时流程
# @name stop_scheduled_flow
POST {{baseUrl}}/flows/{{flowId}}_scheduled/stop
Content-Type: application/json

### 3.4 手动执行流程的一个周期
# @name execute_flow_cycle
POST {{baseUrl}}/flows/{{flowId}}/cycles
Content-Type: application/json

{
  "cycle": {{cycle}}
}

### 3.5 获取特定周期状态
# @name get_cycle_status
GET {{baseUrl}}/flows/{{flowId}}/cycles/{{cycle}}
Content-Type: application/json

### 3.6 停止特定节点
# @name stop_code_node
POST {{baseUrl}}/nodes/{{flowId}}_{{cycle}}_{{codeNodeId}}/stop
Content-Type: application/json

### 3.7 获取所有节点信息
# @name get_all_nodes
GET {{baseUrl}}/nodes
Content-Type: application/json

### 3.8 获取节点类型信息
# @name get_node_types
GET {{baseUrl}}/nodes/types
Content-Type: application/json

# =============================================================================
# Part 4: 错误处理测试 (Error Handling Tests)
# =============================================================================

### 4.1 测试无效流程ID
# @name test_invalid_flow_id
GET {{baseUrl}}/flows/invalid_flow_id/status
Content-Type: application/json

### 4.2 测试缺少必需字段的节点执行
# @name test_missing_fields_node
POST {{baseUrl}}/nodes/execute
Content-Type: application/json

{
  "flow_id": "{{flowId}}",
  "node_id": "{{codeNodeId}}",
  "node_type": "code_node"
}

### 4.3 测试不支持的节点类型
# @name test_unsupported_node_type
POST {{baseUrl}}/nodes/execute
Content-Type: application/json

{
  "flow_id": "{{flowId}}",
  "component_id": 0,
  "cycle": {{cycle}},
  "node_id": "test_invalid_node",
  "node_type": "invalid_node_type",
  "config": {
    "node_class_type": "invalid_node_type"
  }
}

### 4.4 测试无效的流程JSON
# @name test_invalid_flow_json
POST {{baseUrl}}/flows/execute
Content-Type: application/json

{
    "flow_id": "{{flowId}}_invalid",
    "cycle_interval": "0",
    "flow_json": "invalid_json_string"
}

# =============================================================================
# Part 5: 性能和并发测试 (Performance & Concurrency Tests)
# =============================================================================

### 5.1 并发执行多个节点实例
# @name concurrent_node_1
POST {{baseUrl}}/nodes/execute
Content-Type: application/json

{
  "flow_id": "{{flowId}}_concurrent",
  "component_id": 0,
  "cycle": 1,
  "node_id": "{{codeNodeId}}_concurrent_1",
  "node_type": "code_node",
  "config": {
    "node_class_type": "code_node",
    "python_code": "import time\nprint('Concurrent node 1 started')\ntime.sleep(5)\noutput_data = {'node': 'concurrent_1', 'completed': True}\nprint('Concurrent node 1 completed')",
    "input_data": {}
  }
}

### 5.2 并发执行多个节点实例 - 实例2
# @name concurrent_node_2
POST {{baseUrl}}/nodes/execute
Content-Type: application/json

{
  "flow_id": "{{flowId}}_concurrent",
  "component_id": 0,
  "cycle": 1,
  "node_id": "{{codeNodeId}}_concurrent_2",
  "node_type": "code_node",
  "config": {
    "node_class_type": "code_node",
    "python_code": "import time\nprint('Concurrent node 2 started')\ntime.sleep(3)\noutput_data = {'node': 'concurrent_2', 'completed': True}\nprint('Concurrent node 2 completed')",
    "input_data": {}
  }
}

### 5.3 获取工作节点信息
# @name get_worker_nodes
GET {{baseUrl}}/worker/nodes
Content-Type: application/json

# =============================================================================
# 测试说明 (Test Instructions)
# =============================================================================

# 1. 确保Station服务正在运行在端口7002
# 2. 确保Redis和RabbitMQ服务可用
# 3. 按顺序执行测试，先执行单个节点测试，再执行完整流程测试
# 4. 观察日志输出和状态变化
# 5. 测试完成后记得停止正在运行的流程

# 测试覆盖范围：
# - 单个节点执行和状态查询
# - 完整流程执行、监控和控制
# - 定时任务和周期执行
# - 错误处理和边界情况
# - 并发执行和性能测试
# - 日志查询和过滤

# 预期结果：
# - Code Node 应该成功爬取比特币持仓数据并输出结构化数据
# - Dataset Output Node 应该接收数据并完成输出操作
# - 完整流程应该顺利执行且节点间数据传递正确
# - 所有状态查询应该返回正确的执行信息
# - 日志应该包含详细的执行过程记录
