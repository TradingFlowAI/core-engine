### 代码节点测试
@baseUrl = http://localhost:7000

###############################################################################
#################### 代码节点安全测试 #######################
###############################################################################

### 执行代码节点测试 - 安全检测测试（应该失败）
# @name execute_code_node_security_test
POST {{baseUrl}}/nodes/execute
Content-Type: application/json
Accept: application/json

{
  "flow_id": "example_flow",
  "component_id": 5,
  "cycle": 1,
  "node_id": "code_node_security_test",
  "node_type": "code_node",
  "input_edges": [],
  "output_edges": [],
  "config": {
    "node_class_type": "code_node",
    "code": "# 尝试执行危险操作 - 应该被安全检测阻止\nimport os\n\n# 尝试执行系统命令\nos.system('ls -la')\n\noutput_data = {'result': 'This should not be executed'}",
    "timeout": 30,
    "max_gas": 1000,
    "base_gas": 100,
    "max_recursion": 1000,
    "max_memory_mb": 500,
    "input_handles": [],
    "output_handles": []
  }
}

### 响应验证 - 安全检测测试
# 验证响应状态码为200
# 验证task_id字段存在
# 验证status字段存在
# 验证node_task_id字段格式为 "example_flow_5_code_node_security_test"

###############################################################################
#################### 代码节点基本功能测试 ####################
###############################################################################

### 响应验证 - 简单打印测试
# 验证响应状态码为200
# 验证输出中包含"Hello, TradingFlow!"
# 验证执行状态为"completed"
# @name execute_simple_print_code_node
POST {{baseUrl}}/nodes/execute
Content-Type: application/json
Accept: application/json

{
  "flow_id": "example_flow",
  "component_id": 3,
  "cycle": 1,
  "node_id": "simple_print_node",
  "node_type": "code_node",
  "input_edges": [],
  "output_edges": [],
  "config": {
    "node_class_type": "code_node",
    "code": "# 最简单的打印测试\nprint('Hello, TradingFlow!')\nprint('这是一个简单的测试')\nprint('测试完成')",
    "timeout": 10,
    "max_gas": 1000,
    "base_gas": 10,
    "max_recursion": 100,
    "max_memory_mb": 500,
    "input_handles": [],
    "output_handles": ["code_output_handle"]
  }
}


### 响应验证 - 无限循环测试
# 验证响应状态码为200
# 验证task_id字段存在
# 验证status字段存在
# 验证node_task_id字段格式为 "example_flow_6_code_node_infinite_loop"
# @name execute_code_node_infinite_loop
POST {{baseUrl}}/nodes/execute
Content-Type: application/json
Accept: application/json

{
  "flow_id": "example_flow",
  "component_id": 6,
  "cycle": 1,
  "node_id": "code_node_infinite_loop",
  "node_type": "code_node",
  "input_edges": [],
  "output_edges": [],
  "config": {
    "node_class_type": "code_node",
    "code": "# 尝试执行无限循环 - 应该被循环检测终止\ni = 0\nwhile True:\n    i += 1\n    if i % 1000 == 0:\n        print(f'Iteration: {i}')\n\noutput_data = {'result': 'This should not be executed'}",
    "timeout": 30,
    "max_gas": 1000,
    "base_gas": 100,
    "max_recursion": 1000,
    "max_memory_mb": 500,
    "input_handles": [],
    "output_handles": []
  }
}


### 数据处理测试
# @name execute_pandas_data_processing
POST {{baseUrl}}/nodes/execute
Content-Type: application/json
Accept: application/json

{
  "flow_id": "example_flow",
  "component_id": 7,
  "cycle": 1,
  "node_id": "pandas_data_node",
  "node_type": "code_node",
  "input_edges": [],
  "output_edges": [],
  "config": {
    "node_class_type": "code_node",
    "code": "# 简化的测试数据处理\nimport pandas as pd\n\n\n# 创建小型测试数据\ndata = [\n    ['2025-05-01', 50000, 51000, 49500, 50500, 1000],\n    ['2025-05-02', 50500, 52000, 50000, 51800, 1200],\n    ['2025-05-03', 51800, 53000, 51500, 52500, 1500]\n]\n\nheaders = ['date', 'open', 'high', 'low', 'close', 'volume']\n\n# 创建DataFrame - 使用更少的数据\ndf = pd.DataFrame(data, columns=headers)\n\n# 简单计算 - 不使用rolling窗口函数\ndf['avg_price'] = (df['high'] + df['low']) / 2\n\n# 准备输出数据\noutput_data = {\n    'headers': list(df.columns),\n    'data': df.values.tolist(),\n    'summary': {\n        'symbol': 'BTCUSDT',\n        'rows': len(df)\n    }\n}\n\nprint(output_data)",
    "timeout": 30,
    "max_gas": 10000,
    "base_gas": 100,
    "max_recursion": 1000,
    "max_memory_mb": 500,
    "input_handles": [],
    "output_handles": ["code_output_handle"]
  }
}
