# # 进入目录
# cd /opt/tradingflow/python-services

# # 确保.env文件包含 DATA_SERVER_IP=10.0.101.127

# # 运行测试容器
# sudo docker-compose -f docker-compose-connectivity-test.yml up

# # 查看测试结果
# sudo docker-compose -f docker-compose-connectivity-test.yml logs

# # 清理测试容器
# sudo docker-compose -f docker-compose-connectivity-test.yml down

version: "3.8"

services:
  connectivity-test:
    image: python:3.11-slim
    container_name: tradingflow-connectivity-test
    restart: "no" # 只运行一次
    env_file:
      - ./.env
    dns:
      - 8.8.8.8
      - 8.8.4.4
    extra_hosts:
      - "tradingflow-postgres:${DATA_SERVER_IP}"
      - "tradingflow-redis:${DATA_SERVER_IP}"
      - "tradingflow-rabbitmq:${DATA_SERVER_IP}"
    command: >
      bash -c "
      echo '=== 安装测试工具 ===';
      apt-get update -qq;
      apt-get install -y -qq postgresql-client redis-tools curl netcat-traditional iputils-ping;
      pip install psycopg2-binary redis pika requests;

      echo '';
      echo '=== 网络连通性测试 ===';
      echo '1. 测试基础网络连通性...';
      ping -c 3 ${DATA_SERVER_IP} || echo '❌ 无法ping通数据服务器';

      echo '';
      echo '2. 测试端口开放状态...';
      nc -zv ${DATA_SERVER_IP} 5432 && echo '✅ PostgreSQL端口可访问' || echo '❌ PostgreSQL端口不可访问';
      nc -zv ${DATA_SERVER_IP} 6379 && echo '✅ Redis端口可访问' || echo '❌ Redis端口不可访问';
      nc -zv ${DATA_SERVER_IP} 5672 && echo '✅ RabbitMQ端口可访问' || echo '❌ RabbitMQ端口不可访问';
      nc -zv ${DATA_SERVER_IP} 8080 && echo '✅ pgAdmin端口可访问' || echo '❌ pgAdmin端口不可访问';
      nc -zv ${DATA_SERVER_IP} 15672 && echo '✅ RabbitMQ管理端口可访问' || echo '❌ RabbitMQ管理端口不可访问';

      echo '';
      echo '3. 测试DNS解析...';
      nslookup tradingflow-postgres && echo '✅ PostgreSQL DNS解析正常' || echo '❌ PostgreSQL DNS解析失败';
      nslookup tradingflow-redis && echo '✅ Redis DNS解析正常' || echo '❌ Redis DNS解析失败';
      nslookup tradingflow-rabbitmq && echo '✅ RabbitMQ DNS解析正常' || echo '❌ RabbitMQ DNS解析失败';

      echo '';
      echo '=== 数据服务连接测试 ===';

      echo '4. 测试PostgreSQL连接...';
      export PGPASSWORD='${POSTGRES_PASSWORD}';
      psql -h ${DATA_SERVER_IP} -p 5432 -U ${POSTGRES_USER} -d ${POSTGRES_DB} -c 'SELECT version();' && echo '✅ PostgreSQL连接成功' || echo '❌ PostgreSQL连接失败';
      psql -h tradingflow-postgres -p 5432 -U ${POSTGRES_USER} -d ${POSTGRES_DB} -c 'SELECT version();' && echo '✅ PostgreSQL DNS连接成功' || echo '❌ PostgreSQL DNS连接失败';

      echo '';
      echo '5. 测试Redis连接...';
      redis-cli -h ${DATA_SERVER_IP} -p 6379 -a '${REDIS_PASSWORD}' ping && echo '✅ Redis连接成功' || echo '❌ Redis连接失败';
      redis-cli -h tradingflow-redis -p 6379 -a '${REDIS_PASSWORD}' ping && echo '✅ Redis DNS连接成功' || echo '❌ Redis DNS连接失败';

      echo '';
      echo '6. 测试Web管理界面...';
      curl -s -I http://${DATA_SERVER_IP}:8080 | head -n 1 && echo '✅ pgAdmin Web可访问' || echo '❌ pgAdmin Web不可访问';
      curl -s -I http://${DATA_SERVER_IP}:15672 | head -n 1 && echo '✅ RabbitMQ Web可访问' || echo '❌ RabbitMQ Web不可访问';

      echo '';
      echo '=== 环境变量检查 ===';
      echo 'DATA_SERVER_IP:' ${DATA_SERVER_IP};
      echo 'POSTGRES_HOST:' ${POSTGRES_HOST};
      echo 'POSTGRES_USER:' ${POSTGRES_USER};
      echo 'POSTGRES_DB:' ${POSTGRES_DB};
      echo 'REDIS_HOST:' ${REDIS_HOST};
      echo 'RABBITMQ_HOST:' ${RABBITMQ_HOST};
      echo 'RABBITMQ_USER:' ${RABBITMQ_USER};

      echo '';
      echo '=== 测试完成 ===';
      echo '如果看到任何❌，说明对应的服务连接有问题';
      echo '请检查安全组、网络配置和服务状态';
      "
    networks:
      - tradingflow-network

networks:
  tradingflow-network:
    driver: bridge
